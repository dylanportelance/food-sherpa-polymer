<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/core-media-query/core-media-query.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/yoso-searchfield/yoso-searchfield.html">
<link rel="import" href="../dd-search/dd-search.html">
<link rel="import" href="../dd-results/dd-results.html">
<link rel="import" href="../dd-data/dd-data.html">

<polymer-element name="dd-app">
  <template>
    <style>
      :host {
        position: absolute;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      core-header-panel {
        position: absolute;
        top: 0px;
        right: 0px;
        bottom: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
      }

      .grade {
        float: left;
        padding: 6px 16px 43px;
        color: white;
        font-weight: bold;
        text-align: center;
        height: 100%;
        margin: 0;
      }
      .grade.A { background-color: darkgreen; }
      .grade.B { background-color: green; }
      .grade.C { background-color: orange; }
      .grade.D { background-color: red; }
      .grade.F { background-color: darkred; }

      .background-fill {
        background-color: #eee;
      }
      .core-header {
        height: 60px;
        line-height: 60px;
        font-size: 18px;
        padding: 0 10px;
        background-color: #4F7DC9;
        color: #FFF;
        transition: height 0.2s;
      }

      .content {
        padding: 0 10px;
      }

      paper-progress {
        width: 100%;
        visibility: hidden;
      }

      paper-input {
        display: block;
      }

      paper-shadow {
        margin-bottom: 10px;
      }

      .input {
        padding: 10px;
      }

      .info { padding: 10px; }
      h4, .info > div { margin: 0 0 10px; }
    </style>

    <core-media-query
      query="max-width: 640px"
      queryMatches="{{phoneScreen}}">
    </core-media-query>

    <core-header-panel id="core_header_panel">
      <paper-progress id="progress" bottom fit indeterminate></paper-progress>
      <!--<paper-progress id="progress"-->
      <!--  bottom fit-->
      <!--  min="0"-->
      <!--  value={{progress.loaded}}-->
      <!--  max="{{progress.lengthComputable}}">-->
      <!--</paper-progress>-->
      <div class="core-header">
        Dirty Dishes :: Boston
      </div>

      <div class="content">
        <paper-input
          floatingLabel
          label="Search by restaurant name"
          value="{{searchTerm}}"
          id="byName">
        </paper-input>

        <template repeat="{{ result in results }}">
          <paper-shadow id="restaurant-{{result.ID}}" layout horizontal>
            <div layout vertical>
              <h1 class="grade {{result.Grade}}" >{{ result.Grade }}</h1>
              <div class="background-fill" flex></div>
            </div>
            <div class="info" layout
              horizontal="{{!phoneScreen}}"
              vertical="{{phoneScreen}}">

              <div class="address">
                <h4>{{ result.BusinessName }}</h4>
                <small>
                {{ result.Address }}<br />
                {{ result.City }}, {{ result.State }} {{ result.ZIP }}
                </small>
              </div>

              <div class="actions" right?={{!phoneScreen}}>
                <div layout horizontal>
                  <paper-button id="violations-{{result.ID}}"
                    on-click="{{showViolations}}">
                    View Violations
                  </paper-button>
                  <paper-button on-click="{{viewYelp}}">
                    View on Yelp!
                  </paper-button>
                </div>
              </div>
            </div>
          </paper-shadow>


          <paper-action-dialog id="violation_dialog_{{ result.ID }}"
            backdrop
            class="scrolling"
            transition="core-transition-center">

            <table cellpadding=2>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Level</th>
              </tr>
              <template repeat="{{ violation in result.violArray }}">
                <tr>
                  <td>{{violation.ViolDate}}</td>
                  <td>{{violation.ViolDesc}}</td>
                  <td>{{violation.ViolLevel}}</td>
                </tr>
              </template>
            </table>
            <paper-button affirmative autofocus>Close</paper-button>
          </paper-action-dialog>
        </template>

        <core-ajax id="dd_api"
          handleAs="json"
          progress="{{progress}}"
          on-core-response="{{handleResponse}}">
        </core-ajax>
      </div>
    </core-header-panel>
  </template>

  <script>
    Polymer({
      results: {},
      searchTerm: "",
      searchTimeout: null,

      searchTermChanged: function(oldValue, newValue) {
        var that = this;

        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(delayedAjaxCall, 500);

        function delayedAjaxCall() {
          if(newValue) {
            var searchUrl;
            searchUrl = "http://104.236.242.57/api/v1.0/restaurants/name/";
            searchUrl += newValue;

            that.$.progress.style.visibility = "visible";
            that.$.dd_api.url = searchUrl;
            that.$.dd_api.go();
          }
        };
      },
      showViolations: function(event,response,context) {
        var restuarantID = context.id.split("-")[1];
        var dialog = this.shadowRoot.querySelector("#violation_dialog_" + restuarantID);
        dialog.toggle();
      },
      handleResponse: function(event, response, context) {
        var filteredResults = response.response;

        this.results = _.chain(filteredResults)
          .filter({ "LICSTATUS": "Active"})
          .map(function(d) {
            d.violArray = _.chain(d.violations)
              .values()
              .sortBy("ID")
              .reverse()
              .value();

            return d;
          })
          .sortBy("Grade")
          .value();

        this.$.progress.style.visibility = "hidden";
      }
    });
  </script>
</polymer-element>